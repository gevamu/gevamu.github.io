# 3. Payment initiation

1. The Participant initiates the payment transaction off-chain via a Web UI. The payment request is handled by a web server on the Participant’s node of the Corda business network and sent via Corda RPC to the custom Payment CorDapp installed on the Participant’s node on-chain.

2. The Participant’s request is accepted by the CorDapp on the Participant’s node and is transformed to a payment instruction formatted according to the industry-accepted payment standard (ISO 20022 formatted XML representing a `CustomerCreditTransferInitiation` message) to be passed to Gevamu Payments SDK. Gevamu Payments SDK pre-validates the payment instruction and creates a state (or several states if multiple payments are instructed) with an attachment containing the original payment instruction.

3. The payment instruction is sent to Gevamu Payments Gateway.

4. The Gevamu Payments Gateway validates the payment instruction. If valid, its status is updated (to reflect that the payment instruction is accepted by the Payments Gateway for further delivery); the payment instruction itself is sent to the external gateway of the PSP. If not valid, a corresponding status is sent back to the Participant’s CorDapp.  
  
    The payments gateway checks if the Participant is authorized to submit this payment request, it validates the payment instruction from the following aspects:
    - Node Identity – whether a payment request is received from the node that initially registered the Participant initiating the request;
    - Participant ID – whether the Participant is registered with the Payments network and if Participant ID is registered to the Participant’s node;

5. Once the PSP replies to the payment request, a returned payment status (_Accepted_, _Pending_ or _Rejected_) is propagated back to the Participant’s node. The updated status is made available as a new Corda state in the payment statuses chain.
  
    The participant’s CorDapp may subscribe to the payment state updates to be notified on Payment processing progress.

6. If the payment instruction cannot be immediately settled by the PSP, the PSP notifies the Payments Gateway when the payment status is updated. The Payments Gateway transfers the updated payment request status to the Participant’s node.


Sequence Diagram 

```mermaid
---
title: Initiate Payment
---
sequenceDiagram
    %% Participants
    participant pn as Payments Node <br/> with Custom CorDapp and Payments SDK 
    participant gpg as Gevamu Payment Gateway
    participant psp as PSP/Bank

    pn ->> pn: recieved Payment instruction  <br/> transformed into ISO 20022 formatted XML.
    pn ->> pn: XML prevalidated by SDK

    %% prevalidation by SDK
    alt PreValidation passes
        pn  ->>  pn: Corda state is created
        pn  ->> gpg: Payment request<br/>[SendPaymentFlow]
        gpg ->> gpg: Validate request <br/> checks Node and Participant Identity

        ## validation by Gateway
        alt Validation by Gateway Passes
            gpg ->> gpg: Corda State Updated to Valid
            gpg ->> psp: payment instruction <br /> (SendPaymentFlowResponder)
            gpg ->> pn: Payment Status: Sent to Gateway <br/> corda state updated

            %% immediate decision by PSP
            alt Request is Immediately processed by PSP
                psp ->> gpg: Payment Status: accepted or rejected
                gpg ->> pn : Payment Status: status from PSP passed to cordapp <br/>(StatusUpdateFlow)
            
            else Request is not Immediately processed by PSP
                psp ->> gpg: Payment Status: pending and Accepted or Rejected
                gpg ->> pn : Payment Status: status from PSP passed to corDapp <br/> (StatusUpdateFlow)

            end

        %% validation by gateway fails
        else Validation by Gateway Fails
            gpg ->> gpg: Corda State Updated to InValid
            gpg ->> pn : Status update informed to CordApp

        end

    %% prevalidation
    else alt PreValidation Fails

    Note right of pn: Corda State not created
            
    end
```